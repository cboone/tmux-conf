#!/usr/bin/env bash
# bin/update-defaults - Regenerate defaults/*.conf from an unconfigured tmux server
# Author: Christopher Boone
# Date: 2026-02-21

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCRIPT_DIR
readonly REPO_DIR="${SCRIPT_DIR}/.."
readonly DEFAULTS_DIR="${REPO_DIR}/defaults"
readonly SOCKET_NAME="unconfigured"

# File tracking the tmux version used to generate defaults. The script refuses
# to run if the installed tmux doesn't match, unless --accept-version is passed
# to adopt a new version.
readonly VERSION_FILE="${REPO_DIR}/.tmux-version"

# Options whose values depend on the local environment rather than tmux
# defaults. Each line in the generated output matching one of these option names
# is commented out with a descriptive placeholder.
declare -A ENV_DEPENDENT_OPTIONS=(
  [default-shell]="\$SHELL"
  [editor]="\$EDITOR"
)

# Kill the unconfigured tmux server on exit, if it is running.
# Arguments: none
# Returns: 0
function cleanup() {
  local exit_code="${?}"
  tmux -L "${SOCKET_NAME}" kill-server 2>/dev/null || true
  exit "${exit_code}"
}

# Extract the tmux command from a file's header comment.
# Arguments:
#   $1 - Path to a defaults/*.conf file
# Outputs:
#   Writes the raw command (without "# " prefix) to stdout
# Returns:
#   0 if header found, 1 if missing or invalid
function extract_command() {
  local file="${1}"
  local header
  header="$(head -n 1 "${file}")"

  if [[ "${header}" != "# "* ]]; then
    return 1
  fi

  printf '%s\n' "${header#\# }"
}

# Replace environment-dependent option values with placeholder comments.
# Reads lines from stdin and writes processed lines to stdout.
# Options listed in ENV_DEPENDENT_OPTIONS are commented out with their
# placeholder value (e.g., "editor /usr/bin/vi" becomes "# editor $EDITOR").
# Arguments: none
function sanitize_env_options() {
  local line opt_name placeholder
  while IFS= read -r line; do
    opt_name="${line%% *}"
    if [[ -n "${ENV_DEPENDENT_OPTIONS["${opt_name}"]:-}" ]]; then
      placeholder="${ENV_DEPENDENT_OPTIONS["${opt_name}"]}"
      printf '# %s %s\n' "${opt_name}" "${placeholder}"
    else
      printf '%s\n' "${line}"
    fi
  done
}

# Regenerate a single defaults file by running its header command.
# Arguments:
#   $1 - Path to a defaults/*.conf file
# Returns:
#   0 on success, 1 on failure (with warning to stderr)
function update_file() {
  local file="${1}"
  local basename="${file##*/}"
  local command
  command="$(extract_command "${file}")" || {
    printf 'warning: skipping %s (no valid header comment)\n' "${basename}" >&2
    return 1
  }

  local output
  # eval is needed here because the header commands use both \; escaping
  # (for tmux command separation) and shell pipes (for grep filtering).
  # The command source is controlled: our own header comments, not user input.
  # shellcheck disable=SC2294
  output="$(eval "${command}")" || {
    printf 'warning: command failed for %s\n' "${basename}" >&2
    return 1
  }

  # Sanitize environment-dependent options in show-options output.
  output="$(printf '%s\n' "${output}" | sanitize_env_options)"

  printf '# %s\n\n%s\n' "${command}" "${output}" > "${file}"
  printf 'updated %s\n' "${basename}" >&2
}

function main() {
  local accept_version=false
  while [[ "${#}" -gt 0 ]]; do
    case "${1}" in
      --accept-version) accept_version=true; shift ;;
      *)
        printf 'usage: update-defaults [--accept-version]\n' >&2
        exit 1
        ;;
    esac
  done

  if ! command -v tmux > /dev/null 2>&1; then
    printf 'error: tmux is not installed\n' >&2
    exit 1
  fi

  local tmux_version
  tmux_version="$(tmux -V | cut -d' ' -f2)"
  printf 'tmux %s\n' "${tmux_version}" >&2

  # Read the expected version from .tmux-version.
  local expected_version=""
  if [[ -f "${VERSION_FILE}" ]]; then
    expected_version="$(< "${VERSION_FILE}")"
    expected_version="${expected_version%%[[:space:]]}"
  fi

  if [[ "${tmux_version}" != "${expected_version}" ]]; then
    if [[ "${accept_version}" == true ]]; then
      printf '%s\n' "${tmux_version}" > "${VERSION_FILE}"
      printf 'Updated .tmux-version: %s -> %s\n' "${expected_version}" "${tmux_version}" >&2
    else
      printf 'error: expected tmux %s (from .tmux-version), found %s\n' "${expected_version}" "${tmux_version}" >&2
      printf 'Defaults vary between tmux versions. Either:\n' >&2
      printf '  - Install tmux %s to regenerate with the current version\n' "${expected_version}" >&2
      printf '  - Run with --accept-version to adopt tmux %s\n' "${tmux_version}" >&2
      exit 1
    fi
  fi

  trap cleanup EXIT

  local file
  local -i failures=0
  for file in "${DEFAULTS_DIR}"/*.conf; do
    if [[ ! -f "${file}" ]]; then
      printf 'warning: no .conf files found in %s\n' "${DEFAULTS_DIR}" >&2
      exit 1
    fi
    update_file "${file}" || ((failures++))
  done

  if ((failures > 0)); then
    printf '\n%d file(s) had warnings\n' "${failures}" >&2
  fi
}

main "${@}"
